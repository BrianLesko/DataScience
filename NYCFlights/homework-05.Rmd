---
title: "homework-05"
author: "Brian J Lesko"
date: '2022-06-09'
output: prettydoc::html_pretty
---

```{r setup, include=FALSE}
# Enable echo by default, disable messages, and enable cache to reduce 
# knitting time when we make minor changes
knitr::opts_chunk$set(echo = TRUE, message = FALSE, cache = TRUE)
```

```{r warning = FALSE, message = FALSE, cache = FALSE}
 library(tidyverse)
library(nycflights13)
```

# Reading: R4DS 5.6-5.7

## Reading notes
### 5.6
group_by() & summarise() can let you apply things by group? 
instead of naming each transformation step, a pipe can be used %>%
the pipe operation %>% can be read as a then statement
usually you want to remove NA's with the argument na.rm =TRUE

# R4DS Exercises

## 5.6.7 (1-6)
Hints: 
+ for exercise 4, plot x=day and facet by month. Think about weather
+ Try a scatterplot for part 2, experiment with log scales

### Exercise 1
brainstorm 5+ ways to assess the typical delay characteristics of a group of flights. Consider these scenarios
+ a flight is 15 min early 50% of the time and 15 min late 50% of the time
  This will result in an average of no delay, which is misleading. 
+ a flight is always 10 minutes late
+ same scenario as the first but 30 minutes late/early this time
+ 99% on time 1% of the time the flight is delayed. 

*5 Ways to assess delay characteristics:*
group flights by airport, then analyze

1. obtain descriptive statistics: a measure of 
  Central tendancy(like mean), Dispersion (like standard deviation) of delay
  can be done for arrival delay and departure delay
  These are characteristics of delay by grouped flights 
  
2. Plot delays to visualize them
  2.1 Facet by airline or other categorical variables 
    characterize delay by airline
  2.2 (3) plot mean delays of groups vs average flight duration
    Can also facet by airline
    this characterises delay by flight duration
  2.3 (4) use aesthetics to get an overview
    can test out the relationship between arrival and departure delay
    
5. Range can be useful due to early arrivals being marked as negative delays. 

6. Alternative to using range, early arrivals can be filtered out to only characterize delayed flights. 
  
7. delays can also affect following flights. 

8. degree of skew and kurtosis can also be important

What is more important? arrival or departure delay?
arrival delay because time can be recouped after a late departure, but not after arrival, which makes this stat more important. 

### Exercise 2 
characterize delay such that the output is the same as the following code block but do not use the count() function 

```{r}
# we need the code written previously in the chapter in order to have the objects refrenced within this exercise. Below are the required lines

#removing NA's is removing cancelled flights in this dataset (established previously)
not_cancelled <- flights %>%
  filter(!is.na(dep_delay),!is.na(arr_delay))

#grouping the data by year month and day
not_cancelled %>%
  group_by(year,month,day) %>%
  summarise(mean = mean(dep_delay)) #now the dataset consists of one row per day with the mean values for dep_delay instead of one row per flight. 
```


```{r}
library(tidyverse)
library("nycflights13")

# the useage of counting is good to make sure conclusions are not based on small datasets
not_cancelled %>% count(dest) # this counts number of flights out of each airport
not_cancelled %>% count(tailnum, wt=distance) #this counts flights per plane in the dataset

#This shows that count() groups and then summarises such that the outputs are roughly equivelenat
not_cancelled %>% group_by(dest) %>% summarise(n=n())
not_cancelled %>% group_by(tailnum) %>% summarise(n=n())
#Alternatively, the summarise argument can be changed to n=sum(!is.na()))
```

### Exercise 3 
Our definition of cancelled flights (is.na(dep_delay) | is.na(arr_delay) ) is slightly suboptimal. Why? Which is the most important column?

Arrival delay is more imporant. when lookin at the data, there are flights that leave but do not arrive. These flights have a dep_delay but have NA as their arr_delay

this means that dep_delay being NA is irrelevant when looking for cancelled flights

```{r}
#to see the NA's
filter(flights, is.na(dep_delay))
#It is seen that some cancelled flights do indeed havea  departure time where no cancelled flights have an arrival time. Therefor, the arrival time is more important
filter(flights, is.na(arr_delay))
```

### Exercise 4
Look at the number of cancelled flights per day. Is there a pattern? Is the proportion of cancelled flights related to the average delay?

```{r}

#Scratch work

#Finding the number of cancelled flights per day 
cancelled_flights_per_day <- flights %>%
  filter(is.na(arr_time)) %>%
  group_by(year,month,day) %>%
  summarise(n=n())   #Instead of using group_by and summarise, counts() can be used

cancelled_flights_per_day

#Finding the average delay per day 
avg_delay <- not_cancelled %>% group_by(year,month,day) %>% summarise(mean=mean(arr_delay))
avg_delay
  

```
```{r}
#More concise and usable work
#cancelled and delay info must be in the same tibble / data frame

to_plot <- flights %>%
  mutate(cancelled=is.na(arr_delay)) %>% 
  group_by(year,month,day) %>% #needed so we compare only flights per day
  summarise(cancelled_num = sum(cancelled),
            flights_tot = sum(year)/2013,
            mean_dep_delay = mean(dep_delay,na.rm=TRUE))

ggplot(to_plot, mapping = aes(x=mean_dep_delay,y=cancelled_num))+
  geom_point()+#mapping=aes(x=mean_dep_delay,y=cancelled_num,size=flights_tot))+
  geom_smooth()


```

The plot shows that there is a positive relationship between average departure delay and cancelled flights on any one day

Further analysis
facet by month and think of weather as stated by the hints. x = day
```{r}
ggplot(to_plot, mapping = aes(x=day,y=(log10(cancelled_num))))+
  geom_point()+
  geom_smooth()+
  facet_wrap(vars(month),ncol=4)
```
As given as a hint, log scales were experimented with along with faceting by month. This makes it seem that more cancellations happen in the winter and midsummer. This can make sense because weather can be the most inclement during these times. 

### Exercise 5
Which carrier has the worst delays? Challenge: can you disentangle the effects of bad airports vs. bad carriers? Why/why not? (Hint: think about flights %>% group_by(carrier, dest) %>% summarise(n()))

Challenge:
from the following data frame given in the question, it seems that the carrier and destination were able to be disentangled. However, it also seems that the dataset now has low numbers of flights for some combinations of carrier and destination. This does not promote accurate analysis of each combination due to low sample size. 

```{r}
disentangled  <- not_cancelled %>%
  group_by(carrier,dest) %>%
  summarise(n())

disentangled
```

```{r}
to_plot <- not_cancelled %>%
  group_by(carrier) %>%
  summarise(mean_delay = mean(arr_delay),flight_count = n())

ggplot(to_plot,mapping=aes(x=carrier,y=mean_delay))+
  geom_point(mapping=aes(x=carrier,y=mean_delay,size=flight_count))
```
From this plot, the mean delays of each airline can be seen, along with the number of flights that airline offers. EV is one of the worst at a larger sample size

### Exercise 6
What does the sort argument to count() do. When might you use it?

Tests
```{r}
count(not_cancelled,carrier)

#above is the same as 

not_cancelled %>% count(carrier) %>% arrange(desc(n))

#it is seen that count will group by and then summarise, this was used earlier in the exercises as well. 

#exploring what sort does 
not_cancelled %>% count(carrier,sort=TRUE)

#the sort functions just as the arrange, its default is false
```


## 5.7.1 (1-5) & (7-8)
Hints:
+ for exercise 5, group and arrange the rows of flights such that consecutive rows are comparable so that lag() can be used.
+ for example, youll only want to compare flights from the same airport on the same day, then make a scatterplot of the flight delay vs the delay of the flight immediately afer

For the “challenge” part of R4DS 5.6.7 Exercise 5, think about how the you could explore if the destinations flow by carriers is different. For example, does the “worst” carrier fly to just a few destinations? Do other carriers also perform similarly with those destinations? Are there “worst” destinations in terms of delays? You can make a plot or a few summaries to begin this exploration, but you do not need to come up with a definitive answer. What’s important is understanding that there is a potential effect of the destination and also an interaction between the destination and carrier.

For R4DS 5.7.1 Exercise 1, you can refer to R4DS 5.5.1 (Useful creation functions) and ignore the list of useful filtering functions (there doesn’t seem to be any such list in R4DS). The important concept of this exercise is to think about how the unit analysis changes from the entire data frame to individual groups when you use group_by().

### Exercise 1 
describe how each mutate and filter function operation changes when combined with grouping 

Mutate
  Usually adds new variables and preserves existing ones
  
  Filter with rank function
    ranking will now find the worst or best (depending on desc() or not) in each group 
    
  Filter with n() 
    all groups following an equality statement will now be filtered such as n() > 10 will yield all groups with 10 or more entries
    
  mutate after grouping
    compute per group metrics
    
### Exercise 2 
which plane has the worst on-time record (tailnum)

```{r}
worst_flights <- not_cancelled %>%
  group_by(tailnum) %>%
  summarise(num_flights=n(),mean_delay=mean(arr_delay)) %>%
  arrange(desc(mean_delay)) %>%
  filter(num_flights>=20)

worst_flights
```

The single worst delay was from plane N844MH, but this only has one flight. 
It is more appropriate to consider only flights with significant history, say 20 or more flights. Using this, the worst average arrival delay comes from plane N203FR.

### Exercise 3
What time of day is the best to fly if you want to avoid delays? 

```{r}
#best_time_to_fly <- flights %>%
  
  
#rudimentary inspection
ggplot(flights,mapping=aes(x=dep_time,y=arr_delay))+
  geom_smooth()
#there are many points here. so the smooth geom works the best. 
#this indicates that a departure time between 500 and 1000 works best. 
#these correspond to local time zones of between 5am and 10am
#the ends of the plot could be misleading, a graphical approach may not be optimal. Sorting the dataset by hour may be better

#Sorting by hour
best_time_to_fly <- not_cancelled %>%
  group_by(hour) %>%
  summarise(mean_delay=mean(arr_delay)) %>%
  arrange((mean_delay))
  
  
best_time_to_fly
#This approach also shows that leaving early, between 5am and 10am is the best time to leave. Interestingly, there are no flights leaving between 1am and 4 am in local time, agreeing with the plot
```
answer is commented

### Exercise 4
for each destination, compute the total minutes of delay.
for each flight, compute the proportion of the total delay for its destination

```{r}
#part 1
delay <- not_cancelled %>%
  group_by(dest) %>%
  mutate(total_delay_for_dest = sum(arr_delay)) %>%
  arrange(dest) #to check it was done correctly 

delay

#ungroup
#unsumarise but keep the data? 

#delay per flight proportionally by destination
delay_prop <- delay %>%
  ungroup() %>%
  mutate(proportion_of_delay = arr_delay/total_delay_for_dest)

delay_prop


```
comment: good use of ungroup! 

### Exercise 5
hints available

methodology:
x axis: delay of previous flight, use lag()
y axis: delay of current flight

```{r}
to_plot <- not_cancelled %>%
  group_by(origin) %>%
  arrange(origin,year,month,day,hour,minute,dep_time) %>%
  mutate(previous_delay = lag(arr_delay)) %>%
  select(day,dep_time,origin,previous_delay,arr_delay,everything())
#select lets me see that I operated as intended

to_plot

ggplot(to_plot,mapping=aes(x=previous_delay,y=arr_delay)) +
  geom_point()+
  geom_smooth()
```
This is the relation I found

### Exercise 7 (skip 6)
find all the destinations that are serviced by at least two carriers. use this info to rank the carriers

```{r}
two_dest <- not_cancelled %>%
  arrange(dest) %>%
  select(dest,carrier,everything()) %>%
  group_by(dest,carrier) %>%
  count(dest) %>%
  ungroup() %>%
  filter(dest==lead(dest) | dest==lag(dest)) 
  #select(carrier,dest,everything())

  two_dest
#this tibble contains only destinations that are flown by at least two carriers, more specifically, there is a row for each destination carrier combination, with a number of flights that the combination hosted.

#now to rank the carriers

ranked <- two_dest %>%
  count(carrier) %>%
  arrange(n) %>%
  select(carrier,num_destinations_serviced=n)
  
ranked


#now that I think of it, I could have done a second count on destination to get the same answer in a more concise manner for part 1. Doing this below

two_dest_improved <- not_cancelled %>%
  arrange(dest) %>%
  select(dest,carrier,everything()) %>%
  group_by(dest,carrier) %>%
  count(dest) %>%
  ungroup() %>%
  count(dest) %>%
  arrange(n) %>%
  select(dest,carriers_servicing=n) %>%
  filter(carriers_servicing>1)

two_dest_improved
```


### Exercise 8
for each plane, count the # of flights before the first delay of greater than 1 hour

```{r}

delay_1h <- not_cancelled %>%
  group_by(tailnum) %>%
  arrange(year,month,day,hour,minute) %>%
  select(month,day,hour,minute,dep_delay,everything()) %>%
  mutate(metric = dep_delay<=60) %>%
  mutate(flight_count = metric+sum(lag(metric),na.rm=T)) %>%
  select(day,hour,minute,dep_delay,metric,tailnum,flight_count,everything())


delay_1h

#this approach proved not to work well

try2 <- not_cancelled %>%
  group_by(tailnum,month,day,hour,minute) %>%
  arrange(tailnum,month,day,hour,minute,.bygroup=TRUE) %>%
  mutate(on_time = dep_delay<60) %>%
  select(tailnum,month,day,hour,minute,on_time,dep_delay,everything()) %>%
  ungroup() %>%
  group_by(tailnum) %>%
  mutate(flight_count=cumsum(on_time)) %>%
  select(flight_count,tailnum,hour,minute,on_time,dep_delay,everything()) %>%
  filter(on_time==FALSE) %>%
  filter(flight_count==min(flight_count)) 
  

try2

#this approach will have two rows for a tailnum if there are two late flights in a row for that plane. 


```


## Additional Exercises (3)

### Exercise 1 
make a plot showing the median dep delay by month. along with a shaded region indicating the lower and upper quartiles like the one given. 

```{r}
newnot_cancelled <- not_cancelled %>%
  group_by(month) %>%
  summarise(median_delay=median(dep_delay),q1=quantile(dep_delay,0.25),q3=quantile(dep_delay,0.75))
  #mutate(dep_delaymed=median(dep_delay)) %>%
  #select(month,dep_delaymed,everything())

ggplot(newnot_cancelled,mapping=aes(x=month,y=median_delay))+
  geom_ribbon(aes(ymin=newnot_cancelled$q1,ymax=newnot_cancelled$q3)) +
  geom_line(aes(color="blue"),show.legend = F)

not_cancelled

```

### Exercise 2
```{r}
newnot_cancelled2 <- not_cancelled %>%
  group_by(hour) %>%
  summarise(median_delay=median(dep_delay),q1=quantile(dep_delay,0.25),q3=quantile(dep_delay,0.75))
  #mutate(dep_delaymed=median(dep_delay)) %>%
  #select(month,dep_delaymed,everything())

ggplot(newnot_cancelled2,mapping=aes(x=hour,y=median_delay))+
  geom_ribbon(aes(ymin=newnot_cancelled2$q1,ymax=newnot_cancelled2$q3)) +
  geom_line(aes(color="blue"),show.legend = F)

not_cancelled
```

### Exercise 3
top 5 destinations per month
top 5 dest per year
use total flight #

```{r}
top_dest <- not_cancelled %>%
  group_by(month,dest) %>%
  summarise(n=n()) %>%
  arrange(month,desc(n),by_group=T) %>%
  mutate(rank=rank(desc(n))) %>%
  filter(rank<=5) %>%
  ungroup() #%>%
  #count(dest)

top_dest

ggplot(data=top_dest) +
  geom_bar(mapping=aes(x=month,fill=dest))#,position="dodge")


```
The plot shows that the most popular destinations do change with the month, with some that stay year round. This may be because of weather patterns that make certain destinations best at a certain time of year. The bars show the 5 top destinations for each month. 

now to get the top 5 destinations for the year
```{r}
top_dest <- not_cancelled %>%
  group_by(dest) %>%
  summarise(n=n()) %>%
  arrange(desc(n),by_group=T) %>%
  mutate(rank=rank(desc(n))) %>%
  filter(rank<=5) %>%
  ungroup() #%>%
  #count(dest)

top_dest
```




## Discussion for module 5
```{r}

columbus_flights <- not_cancelled %>%
  filter(arr_delay<0) %>%
  group_by(dest) %>%
  summarise(number=n()) %>%
  arrange()

columbus_flights

#Page 3 has Columbus (CMH) at a count of 1842 early flights

```





